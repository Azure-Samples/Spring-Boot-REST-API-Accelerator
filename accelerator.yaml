#
# This section defines the settings that affect how the User interface
# presented to users see docs at
# https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.3/tap/GUID-application-accelerator-creating-accelerators-accelerator-yaml.html#accelerator-0
#
accelerator:
  displayName: SpringBoot REST API
  description: An example showing how to build a rest API using Spring Boot & Azure Spring Apps Enterprise.
  iconUrl: https://raw.githubusercontent.com/sample-accelerators/icons/master/icon-cloud.png
  tags:
    - Java
    - Spring
    - API
  options:
    #
    # UI options to set the java version for the project
    #
    - name: javaVersion
      dataType: string
      required: true
      defaultValue: "11"
      label: Which Java version do you want to use?
      description: Java version used by the generated project
      inputType: select
      choices:
        - text: 11
          value: "11"
        - text: 17 (Recommend)
          value: "17"

    #
    # UI options to get the package name for the generated java code
    #
    - name: packageName
      dataType: string
      required: true
      defaultValue: "com.acme"
      label: Package name
      description: Name of the package to put generated code under

    #
    # UI options to select if an Azure Key Vault is required
    #
    - name: keyVault
      dataType: boolean
      defaultValue: false
      label: "Azure Key Vault"
      description: "Configures project to use Azure Key Vault and produces ARM template to create a vault"
    - name: keyVaultName
      dataType: string
      required: true
      defaultValue: "myvault"
      label: "Vault Name"
      description: "3-24 chars long. Alphanumerics and hyphens (dash). Start with a letter. End with a letter or digit. Can not contain consecutive hyphens. Key Vault names must be globally unique."
      dependsOn:
        name: keyVault
        value: true
#    - name: keyVaultResourceGroup
#      dataType: string
#      required: true
#      label: "Resource Group"
#      description: "1-90 characters long. Alphanumerics, underscores, parentheses, hyphens, periods. Can't end with period. Resource Group names must be unique within a subscription."
#      dependsOn:
#        name: keyVault
#        value: true

#
# The engine section describes how to take the files from the accelerator root directory and transform them
#  into the contents of a generated project zip file.
#
# Overview docs at
# https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.3/tap/GUID-application-accelerator-creating-accelerators-accelerator-yaml.html#engine-4
#
# Transform docs at
#

engine:
  merge:

    #
    # include all files except the ones that for sure we don't need and
    # files that are needed if certain conditions are true
    #
    - include: [ "**/**" ]
      exclude: [  "accelerator.yaml", "accelerator.md", "azure/**", "**/*.java", "snippets/**" ]

    #
    # Refactor the package name of the generated java code to
    # package name entered by the user
    #
    - include: ["**/*.java"]
      chain:
        - type: OpenRewriteRecipe
          recipe: org.openrewrite.java.ChangePackage
          options:
            oldPackageName: "'com.example'"
            newPackageName: "#packageName"
    #
    # transform the pom.xml based on the input values
    #  - set the artifact id
    #  - set the java version
    #  - configure maven dependencies
    #
    - include: [ "pom.xml" ]
      chain:
        - type: ReplaceText
          substitutions:
            - text: Spring-Boot-REST-API-Accelerator
              with: "#artifactId"
        - type: ReplaceText
          condition: "#javaVersion == '17'"
          substitutions:
            - text: <java.version>11</java.version>
              with: "'<java.version>17</java.version>'"
        - type: OpenRewriteRecipe
          recipe: org.openrewrite.maven.RemoveDependency
          condition: "#keyVault == false"
          options:
            groupId: "'com.azure.spring'"
            artifactId: "'spring-cloud-azure-starter-keyvault'"
            scope: "'compile'"



    - include: [ "README.md" ]
      chain:
        - type: ReplaceText
          substitutions:
            - text:  Spring-Boot-REST-API-Accelerator
              with: "#artifactId"

    - include: [ "src/main/resources/application.yaml" ]
      condition: "#keyVault == true"
      chain:
        - type: ReplaceText
          substitutions:
            - text: "#ADD-KEY-VAULT-SETTINGS"
              with: "#files.contentsOf('snippets/vault.yaml')"
        - type: ReplaceText
          substitutions:
            - text: vaultname
              with: "#keyVaultName"

    #
    # include key vault ARM template and scripts if the user wants it
    #
    - include: [ "azure/KeyVault/**"]
      condition: "#keyVault == true"

    #
    # set the vault name the one selected by the user
    #
    - include: [ "azure/KeyVault/parameters.json" ]
      condition: "#keyVault == true"
      chain:
        - type: ReplaceText
          substitutions:
            - text: REPLACE-WITH-VAULT-NAME
              with: "#keyVaultName"


